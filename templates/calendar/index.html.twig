{# templates/calendar/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}
    Calendar – {{ targetUser.getFirstName() }} {{ targetUser.getLastName() }}
{% endblock %}

{% block body %}
    <h1>Calendar – {{ targetUser.getFirstName() }} {{ targetUser.getLastName() }}</h1>

    {% if allUsers is not empty %}
        <form method="get"
              action="{{ path('calendar_month_view', { year: year, month: month }) }}">
            View user:
            <select name="userId" onchange="this.form.submit()">
                {% for user in allUsers %}
                    <option
                            value="{{ user.id }}"
                            {{ user.id == targetUser.id ? 'selected' : '' }}
                    >
                        {{ user.getFirstName() }} {{ user.getLastName() }}
                    </option>
                {% endfor %}
            </select>
        </form>
    {% endif %}

    <h2>{{ year }}-{{ '%02d'|format(month) }}</h2>

    {% set firstDayIndex = firstOfMonth.format('w') %}
    {% set daysInMonth   = lastOfMonth.format('t') %}

    {# Compute “commonTags” – true if currentUser and targetUser share any CalendarTag #}
    {% set commonTags = false %}
    {% for myTag in currentUser.getTags() %}
        {% if myTag in targetUser.getTags() %}
            {% set commonTags = true %}
        {% endif %}
    {% endfor %}

    <table class="table table-bordered text-center">
        <thead>
        <tr>
            {% for dayName in ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'] %}
                <th>{{ dayName }}</th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% set dayCounter = 1 %}
        {% for week in 0..5 %}
            <tr>
                {% for dow in 0..6 %}
                    {# Empty cells until we reach the first-of-month #}
                    {% if week == 0 and dow < firstDayIndex %}
                        <td></td>

                    {% elseif dayCounter <= daysInMonth %}
                        {% set dayStr   = '%02d'|format(dayCounter) %}
                        {% set monthStr = '%02d'|format(month) %}
                        {% set dateKey  = year ~ '-' ~ monthStr ~ '-' ~ dayStr %}
                        {% set cellEntry = entryMap[dateKey] is defined ? entryMap[dateKey] : null %}

                        <td style="vertical-align: top;">
                            <div><strong>{{ dayCounter }}</strong></div>

                            {% if cellEntry %}
                                <div>⏱ Hours: {{ cellEntry.getHoursWorked() }}</div>
                                <div>
                                    <a href="{{ path('app_calendar_entry_show', { id: cellEntry.getId() }) }}">
                                        Details
                                    </a>
                                </div>

                            {% else %}
                                {# Only show “+ Add” if: owner OR Admin OR (Manager+commonTags) #}
                                {% if targetUser.id == currentUser.id
                                    or is_granted('ROLE_ADMIN')
                                    or ( is_granted('ROLE_MANAGER') and commonTags )
                                %}
                                    <div style="margin-top: .5em;">
                                        <a href="{{ path('calendar_day_view', {
                                            date: dateKey,
                                            userId: targetUser.id
                                        }) }}">
                                            + Add
                                        </a>
                                    </div>
                                {% endif %}
                            {% endif %}
                        </td>

                        {% set dayCounter = dayCounter + 1 %}

                    {% else %}
                        <td></td>
                    {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock %}
